# Janet Tree-sitter 语法解析器开发计划

## 项目状态
基于Janet 1.38.0语法规范的对比分析，当前项目需要进行以下更新。

## ✅ 已支持的1.38.0新特性
- **IEEE hex floats**: 十六进制指数记数法（如`0x1.3DEp42`）已完整实现
- **基础语法覆盖**: 所有核心语法元素均已实现

## 高优先级更新任务

### 1. 符号字符集Unicode支持 🔥
**问题**: 当前实现与Janet 1.38.0规范存在不一致
- **缺失的Unicode支持**: 符号字符需要支持Unicode码点（`"\x80\xFF"`范围外的字符）
- **当前状态**: 仅支持ASCII字符集
- **Janet 1.38.0规范**: 符号可以包含任何Unicode码点（非ASCII范围）
- **改进位置**: `SYM_CHAR`和`SYM_CHAR_NO_DIGIT_NO_COLON`正则表达式

### 2. 字符串转义序列完善 🔥
**问题**: 字符串转义处理不够完整
- **当前支持**: 基本的`\"`、`\\`转义和简单的`.|\n`模式
- **Janet 1.38.0规范支持**:
  - `\0`（null字符，ASCII 0）
  - `\z`（null字符的另一种表示）  
  - `\f`（换页符，ASCII 12）
  - `\e`（ESC字符，ASCII 27）
  - `\v`（垂直制表符）
  - `\r`（回车符，ASCII 13）
  - `\t`（制表符，ASCII 9）
  - `\n`（换行符，ASCII 10）
  - `\uxxxx`（4位十六进制Unicode）
  - `\Uxxxxxx`（6位十六进制Unicode）
  - `\xHH`（单字节十六进制转义）
- **实现位置**: `STRING_DOUBLE_QUOTE_CONTENT`常量和转义处理逻辑

### 3. 长字符串换行符处理改进 ⚡
**问题**: 长字符串换行处理需要更新
- **Janet 1.38.0变化**: 长字符串现在在`\r\n`上去缩进，而不仅仅是`\n`
- **影响**: Windows风格换行符的处理
- **实现位置**: 外部扫描器`scanner.c`中的长字符串处理逻辑

### 4. 空白字符处理完善 ⚡
**问题**: 空白字符定义需要与Janet规范完全对齐
- **当前**: 基本支持常见空白字符
- **需要验证**: 是否完全匹配Janet的`is_whitespace`函数
- **规范**: ASCII 32、`\0`、`\f`、`\n`、`\r`、`\t`、`\v`

## 中等优先级任务

### 5. Buffer PEG字面量支持 📊
**新特性**: Janet 1.38.0新增Buffer PEG字面量支持
- **当前状态**: 未实现
- **需要添加**: PEG模式中对buffer字面量的支持
- **影响范围**: 不影响基础语法解析，属于高级特性
- **优先级**: 中等（可选特性）

### 6. 测试用例扩展 ⚡
**目标**: 确保所有语法特性有完整的测试覆盖
- **Unicode字符串测试**: 添加包含Unicode字符的字符串测试
- **复杂转义序列测试**: 全面测试所有转义序列组合
- **边界情况测试**: 测试极端数值、嵌套结构等
- **错误处理测试**: 测试无效语法的错误处理

### 6. 性能优化评估 ⚡
**目标**: 确保解析器性能符合预期
- **大文件解析**: 测试大型Janet文件的解析性能
- **内存使用**: 评估内存占用情况
- **解析速度**: 与其他Janet解析器进行基准测试对比

### 7. 文档和示例更新 📝
**目标**: 保持文档的准确性和完整性
- **README更新**: 反映最新功能和兼容性
- **语法示例**: 添加更多Janet语法示例
- **API文档**: 更新tree-sitter集成说明

## 低优先级任务

### 8. 高级特性探索 🚀
**目标**: 考虑未来可能的功能增强
- **语义高亮优化**: 改进`queries/highlights.scm`
- **代码折叠支持**: 添加代码结构感知
- **错误恢复**: 改进语法错误后的解析恢复能力

### 9. 集成测试 🧪
**目标**: 确保与实际Janet生态的兼容性
- **真实项目测试**: 使用真实Janet项目进行测试
- **Janet版本兼容性**: 测试与不同Janet版本的兼容性
- **编辑器集成**: 测试在各种编辑器中的表现

## 实施建议

### 开发顺序
1. 首先处理字符串转义序列（影响最广泛）
2. 然后处理Unicode字符支持（符号和字符串）
3. 完善测试用例确保稳定性
4. 进行性能测试和优化
5. 更新文档和示例

### 测试策略
- **渐进式测试**: 每个功能实现后立即添加测试
- **回归测试**: 确保修改不破坏现有功能
- **Janet兼容性测试**: 与官方Janet解析器结果对比

### 质量保证
- **代码审查**: 每个更改都需要仔细审查
- **基准测试**: 记录性能变化
- **文档同步**: 代码更改时同步更新文档

## 时间估计
- **高优先级任务**: 2-3周
- **中等优先级任务**: 2-4周  
- **低优先级任务**: 1-2周（可选）

## 风险评估
- **兼容性风险**: 更改可能影响现有代码的解析
- **性能风险**: Unicode支持可能影响解析速度
- **测试覆盖风险**: 新功能可能引入未发现的边界情况

## 重要发现 📋

### 与Janet 1.38.0的兼容性评估
经过详细分析，当前项目**已经支持了Janet 1.38.0的大部分关键语法特性**：

✅ **完全支持**:
- IEEE hex floats (十六进制指数记数法) - 完整实现
- 基本数据类型 - 数字、字符串、符号、关键词
- 数据结构 - 元组、数组、表、结构
- 宏语法 - 引用、准引用、短函数等
- 长字符串和缓冲区字面量

⚠️ **需要改进**:
- Unicode符号字符支持（主要影响国际化使用）
- 完整的字符串转义序列支持
- 长字符串Windows换行符处理

🆕 **可选新特性**:
- Buffer PEG字面量支持（高级特性，不影响基础使用）

### 结论
当前项目对Janet 1.38.0的支持度约为**90%**，核心语法功能完备，可以正确解析绝大多数Janet代码。剩余的改进主要是细节完善和边缘特性支持。

---
*更新日期: 2025-01-12*  
*基于: Janet 1.38.0-73334f3 语法规范*